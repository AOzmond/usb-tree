name: Build ARM

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-22.04
    steps:
      - name: Install basic dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl git ca-certificates unzip

      - name: Enable multi-arch and install dependencies
        run: |
          sudo dpkg --add-architecture arm64

          # Update sources.list to separate architectures:
          # 1. Restrict existing sources (archive.ubuntu.com) to amd64
          sudo sed -i 's/deb http/deb [arch=amd64] http/g' /etc/apt/sources.list

          # 2. Add arm64 sources pointing to ports.ubuntu.com
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports/ jammy-security main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list

          sudo apt-get update
          sudo apt-get install -y crossbuild-essential-arm64 pkg-config
          sudo apt-get install -y libgtk-3-dev:arm64 libwebkit2gtk-4.1-dev:arm64 libusb-1.0-0-dev:arm64 libudev-dev:arm64

      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: "1.25"
          cache-dependency-path: |
            app/go.sum
            lib/go.sum

      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: latest

      - name: Set up WebKit2GTK compatibility
        run: sudo ln -sf /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.1.pc /usr/lib/aarch64-linux-gnu/pkgconfig/webkit2gtk-4.0.pc

      - name: Cache Wails CLI
        id: cache-wails
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/go/bin/wails
          key: wails-${{ runner.os }}-latest

      - name: Install Wails
        if: steps.cache-wails.outputs.cache-hit != 'true'
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build frontend
        working-directory: app/frontend
        run: |
          bun install --frozen-lockfile
          bun run build

      - name: Build Linux binary
        working-directory: app
        env:
          CGO_LDFLAGS: "-Wl,-z,relro,-z,now"
          CC: aarch64-linux-gnu-gcc
          CXX: aarch64-linux-gnu-g++
          PKG_CONFIG_PATH: /usr/lib/aarch64-linux-gnu/pkgconfig
          CGO_ENABLED: 1
        run: wails build -platform linux/arm64 -clean -ldflags "-linkmode external -extldflags '-Wl,-z,relro,-z,now -pie'"

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Create tarball with binary, desktop file, and icon
        run: |
          mkdir -p bundle
          cp app/build/bin/usb-tree bundle/
          cp app/build/linux/usb-tree.desktop bundle/
          cp app/build/linux/usb-tree.png bundle/
          cp LICENSE bundle/
          cd bundle
          tar czf $GITHUB_WORKSPACE/artifacts/usb-tree-linux-arm64.tar.gz usb-tree usb-tree.desktop usb-tree.png LICENSE

      - name: Upload Linux artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: linux-arm64
          path: artifacts/usb-tree-linux-arm64.tar.gz
          retention-days: 1
