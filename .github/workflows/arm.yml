name: Build ARM

on:
  push:
    tags:
      - "*"
  workflow_dispatch:

jobs:
  build-linux-arm64:
    name: Build Linux ARM64
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Build frontend
        working-directory: app/frontend
        run: |
          bun install --frozen-lockfile
          bun run build

      - name: Build binary with Wails in Docker
        run: |
          docker run --rm \
            -v ${{ github.workspace }}:/build \
            -w /build/app \
            -e CGO_ENABLED=1 \
            wailsapp/xgo:latest \
            /bin/bash -c "
              # Update Go to 1.25.4 inside the container
              curl -L https://go.dev/dl/go1.25.4.linux-amd64.tar.gz -o go.tar.gz && \
              rm -rf /usr/local/go && tar -C /usr/local -xzf go.tar.gz && \
              export PATH=/usr/local/go/bin:\$PATH && \

              # Configure git to trust the directory
              git config --global --add safe.directory /build && \

              # Install Wails
              go install github.com/wailsapp/wails/v2/cmd/wails@latest && \

              # Build for Linux ARM64
              # -s: Skip frontend build (already done on host)
              wails build -platform linux/arm64 -clean -s -ldflags \"-linkmode external -extldflags '-Wl,-z,relro,-z,now -pie'\"
            "

      - name: Create artifacts directory
        run: mkdir -p artifacts

      - name: Create tarball with binary, desktop file, and icon
        run: |
          mkdir -p bundle
          cp app/build/bin/usb-tree bundle/
          cp app/build/linux/usb-tree.desktop bundle/
          cp app/build/linux/usb-tree.png bundle/
          cp LICENSE bundle/
          cd bundle
          tar czf $GITHUB_WORKSPACE/artifacts/usb-tree-linux-arm64.tar.gz usb-tree usb-tree.desktop usb-tree.png LICENSE

      - name: Upload Linux artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: linux-arm64
          path: artifacts/usb-tree-linux-arm64.tar.gz
          retention-days: 1
