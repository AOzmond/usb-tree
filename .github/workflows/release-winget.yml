name: WinGet submission on release

on:
  release:
    types: [published]

jobs:
  winget:
    name: Publish winget package
    runs-on: windows-latest

    env:
      WINGET_CREATE_GITHUB_TOKEN: ${{ secrets.WINGET_PUBLISH_TOKEN }}

    # Only submit stable releases
    if: ${{ github.event_name == 'release' && !github.event.release.prerelease }}

    steps:
      - name: Submit usb-tree package to Windows Package Manager Community Repository
        shell: pwsh
        run: |
          # Tag name from the release event (e.g. "0.0.5")
          $tag = ${{ toJSON(github.event.release.tag_name) }}

          # Construct the installer URL directly from tag + known file name
          $installerFileName = "usb-tree-amd64-installer.exe"
          $installerUrl = "https://github.com/${{ github.repository }}/releases/download/$tag/$installerFileName"

          Write-Host "Using installer URL: $installerUrl"
          Write-Host "Using package version: $tag"

          # Download latest wingetcreate
          curl.exe -JLO https://aka.ms/wingetcreate/latest

          # Update package using wingetcreate
          .\wingetcreate.exe update USBTree.USBTree `
            --version $tag `
            --urls "$installerUrl|machine" `
            --submit
